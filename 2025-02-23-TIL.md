# GIT TIL 63 - Djangoì—ì„œ ëª¨ë¸ ê°„ ê´€ê³„ ì´í•´í•˜ê¸°

<br>

## 1. ëª¨ë¸ ê´€ê³„ì˜ ê¸°ë³¸ ê°œë…

ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ì˜ ê´€ê³„ë¥¼ ì˜ˆì‹œë¡œ ë“¤ì–´ë³´ì.
```python
# articles/models.py
class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()

class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.CASCADE, related_name='comments')
    content = models.TextField()
```

ì´ë ‡ê²Œ ì„¤ì •í•˜ë©´ ë‘ ê°€ì§€ ë°©í–¥ìœ¼ë¡œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤:
1. ëŒ“ê¸€ â†’ ê²Œì‹œê¸€ (ì •ì°¸ì¡°)
2. ê²Œì‹œê¸€ â†’ ëŒ“ê¸€ë“¤ (ì—­ì°¸ì¡°)

<br>

## 2. ì •ì°¸ì¡°: ìì‹ì´ ë¶€ëª¨ë¥¼ ì°¾ì•„ê°ˆ ë•Œ

ëŒ“ê¸€ì—ì„œ ê²Œì‹œê¸€ì„ ì°¾ëŠ” ê²ƒì´ ì •ì°¸ì¡°ë‹¤. ForeignKeyë¥¼ ì§ì ‘ ê°€ì§€ê³  ìˆëŠ” ìª½ì—ì„œ ì ‘ê·¼í•˜ëŠ” ë°©ì‹ì´ë‹¤.

```python
# views.py
def comment_detail(request, comment_pk):
    comment = Comment.objects.get(pk=comment_pk)
    
    # ëŒ“ê¸€ì´ ì†í•œ ê²Œì‹œê¸€ ì°¾ê¸° (ì •ì°¸ì¡°)
    article = comment.article  # ëŒ“ê¸€ì˜ ê²Œì‹œê¸€
    article_title = comment.article.title  # ê²Œì‹œê¸€ì˜ ì œëª©
```

```html
<!-- comments/detail.html -->
<h2>ëŒ“ê¸€ì´ ë‹¬ë¦° ê²Œì‹œê¸€: {{ comment.article.title }}</h2>
<p>ëŒ“ê¸€ ë‚´ìš©: {{ comment.content }}</p>
```

<br>

## 3. ì—­ì°¸ì¡°: ë¶€ëª¨ê°€ ìì‹ë“¤ì„ ì°¾ì•„ê°ˆ ë•Œ

ê²Œì‹œê¸€ì—ì„œ ëŒ“ê¸€ë“¤ì„ ì°¾ëŠ” ê²ƒì´ ì—­ì°¸ì¡°ë‹¤. related_nameìœ¼ë¡œ ì§€ì •í•œ ì´ë¦„ì´ë‚˜ ê¸°ë³¸ê°’(ëª¨ë¸ëª…_set)ìœ¼ë¡œ ì ‘ê·¼í•œë‹¤.

```python
# views.py
def article_detail(request, article_pk):
    article = Article.objects.get(pk=article_pk)
    
    # ê²Œì‹œê¸€ì˜ ëª¨ë“  ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸° (ì—­ì°¸ì¡°)
    comments = article.comments.all()  # related_name ì‚¬ìš©
    # ë˜ëŠ” comments = article.comment_set.all()  # ê¸°ë³¸ ë§¤ë‹ˆì € ì‚¬ìš©
    
    return render(request, 'articles/detail.html', {
        'article': article,
        'comments': comments,
    })
```

```html
<!-- articles/detail.html -->
<h2>{{ article.title }}</h2>
<p>{{ article.content }}</p>

<h3>ëŒ“ê¸€ ëª©ë¡</h3>
{% for comment in article.comments.all %}
    <p>{{ comment.content }}</p>
{% endfor %}
```

<br>

## 4.DRFì—ì„œì˜ í™œìš©

### Serializerì—ì„œ ê´€ê³„ í‘œí˜„
```python
# serializers.py
class CommentSerializer(serializers.ModelSerializer):
    class Meta:
        model = Comment
        fields = ['id', 'content', 'article']

class ArticleSerializer(serializers.ModelSerializer):
    comments = CommentSerializer(many=True, read_only=True)  # ì—­ì°¸ì¡° ê´€ê³„ í¬í•¨
    
    class Meta:
        model = Article
        fields = ['id', 'title', 'content', 'comments']
```

### 5. API Viewì—ì„œ ì‚¬ìš©
```python
# views.py
class ArticleDetail(APIView):
    def get(self, request, article_pk):
        article = Article.objects.get(pk=article_pk)
        serializer = ArticleSerializer(article)
        return Response(serializer.data)

class CommentCreate(APIView):
    def post(self, request, article_pk):
        article = Article.objects.get(pk=article_pk)
        serializer = CommentSerializer(data=request.data)
        
        if serializer.is_valid():
            serializer.save(article=article)  # ì •ì°¸ì¡° ê´€ê³„ ì„¤ì •
            return Response(serializer.data)
        return Response(serializer.errors)
```

<br>

## 6.ì‹¤ì œ í™œìš© ì‚¬ë¡€

### 6-1. ê²Œì‹œê¸€ ì‚­ì œ ì‹œ ì—°ê´€ ëŒ“ê¸€ ì²˜ë¦¬
```python
# on_delete=models.CASCADE ì„¤ì •ìœ¼ë¡œ ìë™ ì²˜ë¦¬
article.delete()  # ì—°ê´€ëœ ëª¨ë“  ëŒ“ê¸€ë„ ìë™ ì‚­ì œ
```

### 6-2. íŠ¹ì • ì¡°ê±´ì˜ ëŒ“ê¸€ë§Œ ê°€ì ¸ì˜¤ê¸°
```python
# ê²Œì‹œê¸€ì˜ ìµœê·¼ 5ê°œ ëŒ“ê¸€ë§Œ ê°€ì ¸ì˜¤ê¸°
recent_comments = article.comments.order_by('-created_at')[:5]

# íŠ¹ì • ì‚¬ìš©ìê°€ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ê°€ì ¸ì˜¤ê¸°
user_comments = article.comments.filter(user=request.user)
```

<br>

> ğŸ’¡ **TIP**: related_nameì€ ì§ê´€ì ì¸ ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì½”ë“œì˜ ê°€ë…ì„±ì´ ë†’ì•„ì§„ë‹¤. <br>
> ì˜ˆ: `comments`, `likes`, `bookmarks` ë“±

<br><br>



# Django ëª¨ë¸ ê´€ê³„ì—ì„œ ìì£¼ ì“°ëŠ” ë©”ì„œë“œ

<br>

## 7. ì •ì°¸ì¡°ì—ì„œ ìì£¼ ì“°ëŠ” ë©”ì„œë“œ

### 7-1. select_related()
- ì •ì°¸ì¡° ê´€ê³„ì—ì„œ ì¿¼ë¦¬ ìµœì í™”í•  ë•Œ ì‚¬ìš©
- SQLì˜ INNER JOINì„ ìˆ˜í–‰
```python
# N+1 ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ì½”ë“œ
comments = Comment.objects.all()
for comment in comments:
    print(comment.article.title)  # ë§¤ë²ˆ DB ì¡°íšŒ ë°œìƒ

# select_related ì‚¬ìš©ìœ¼ë¡œ ìµœì í™”
comments = Comment.objects.select_related('article').all()
for comment in comments:
    print(comment.article.title)  # ì¶”ê°€ ì¿¼ë¦¬ ì—†ìŒ
```

### 7-2. ForeignKey í•„ë“œ ì ‘ê·¼
```python
# ëŒ“ê¸€ì´ ì†í•œ ê²Œì‹œê¸€ì˜ ì •ë³´ ì ‘ê·¼
comment = Comment.objects.get(pk=1)

# 1. ê²Œì‹œê¸€ ê°ì²´ ê°€ì ¸ì˜¤ê¸°
article = comment.article

# 2. ê²Œì‹œê¸€ì˜ íŠ¹ì • í•„ë“œ ì ‘ê·¼
title = comment.article.title
author = comment.article.author

# 3. ì—†ëŠ” ê´€ê³„ ì²˜ë¦¬
if comment.article is None:
    print("ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤")
```

<br>

## 8. ì—­ì°¸ì¡°ì—ì„œ ìì£¼ ì“°ëŠ” ë©”ì„œë“œ

### 8-1. prefetch_related()
- ì—­ì°¸ì¡° ê´€ê³„ì—ì„œ ì¿¼ë¦¬ ìµœì í™”í•  ë•Œ ì‚¬ìš©
- ë³„ë„ì˜ ì¿¼ë¦¬ë¡œ ê°€ì ¸ì˜¨ í›„ Pythonì—ì„œ ì¡°ì¸
```python
# N+1 ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ì½”ë“œ
articles = Article.objects.all()
for article in articles:
    print(article.comments.count())  # ë§¤ë²ˆ DB ì¡°íšŒ ë°œìƒ

# prefetch_related ì‚¬ìš©ìœ¼ë¡œ ìµœì í™”
articles = Article.objects.prefetch_related('comments').all()
for article in articles:
    print(article.comments.count())  # ì¶”ê°€ ì¿¼ë¦¬ ì—†ìŒ
```

### 8-2. ì—­ì°¸ì¡° ê´€ê³„ ë©”ì„œë“œ
```python
article = Article.objects.get(pk=1)

# 1. ì—°ê²°ëœ ëŒ“ê¸€ ê°œìˆ˜
comment_count = article.comments.count()

# 2. íŠ¹ì • ì¡°ê±´ì˜ ëŒ“ê¸€ë§Œ í•„í„°ë§
recent_comments = article.comments.filter(created_at__gte='2024-01-01')

# 3. ëŒ“ê¸€ ìƒì„±
article.comments.create(content='ìƒˆ ëŒ“ê¸€')

# 4. ëª¨ë“  ëŒ“ê¸€ ì‚­ì œ
article.comments.all().delete()

# 5. ëŒ“ê¸€ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
has_comments = article.comments.exists()
```

<br>

## 9. ì‹¤ì „ì—ì„œ ìœ ìš©í•œ ì¿¼ë¦¬ ìµœì í™” ì˜ˆì‹œ

### 9-1. ì—¬ëŸ¬ ê´€ê³„ë¥¼ í•œ ë²ˆì— ìµœì í™”
```python
# ê²Œì‹œê¸€, ì‘ì„±ì, ëŒ“ê¸€ì„ í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸°
articles = Article.objects.select_related('author')\
                        .prefetch_related('comments')\
                        .all()

for article in articles:
    print(f"ì œëª©: {article.title}")
    print(f"ì‘ì„±ì: {article.author.username}")
    print(f"ëŒ“ê¸€ ìˆ˜: {article.comments.count()}")
```

### 9-2. í•„í„°ë§ê³¼ í•¨ê»˜ ì‚¬ìš©
```python
# íŠ¹ì • ì¡°ê±´ì˜ ëŒ“ê¸€ì´ ìˆëŠ” ê²Œì‹œê¸€ë§Œ ê°€ì ¸ì˜¤ê¸°
articles = Article.objects.prefetch_related('comments')\
                        .filter(comments__created_at__gte='2024-01-01')\
                        .distinct()
```

### 9-3. ì¤‘ì²© ê´€ê³„ ì²˜ë¦¬

#### QuerySetì´ë€?
- ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì „ë‹¬ë°›ì€ ê°ì²´ë“¤ì˜ ëª©ë¡
- ë°ì´í„°ë² ì´ìŠ¤ë¡œë¶€í„° ë°ì´í„°ë¥¼ ì½ê³ , í•„í„°ë§í•˜ê³ , ì •ë ¬í•  ìˆ˜ ìˆìŒ
- ì¥ê³  ORMì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ” í•µì‹¬ ë„êµ¬

#### QuerySetì˜ ì£¼ìš” íŠ¹ì§•
1. Lazy Loading (ì§€ì—° í‰ê°€)
   - QuerySetì„ ë§Œë“œëŠ” ê²ƒì€ ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì„ í¬í•¨í•˜ì§€ ì•ŠìŒ
   - ì‹¤ì œë¡œ ë°ì´í„°ê°€ í•„ìš”í•œ ì‹œì ì— ë°ì´í„°ë² ì´ìŠ¤ì— ì¿¼ë¦¬ë¥¼ ì‹¤í–‰
   ```python
   # ì¿¼ë¦¬ì…‹ ì •ì˜ (ì•„ì§ DB ì ‘ê·¼ ì•ˆí•¨)
   articles = Article.objects.filter(title__contains='Django')
   
   # ì‹¤ì œ DB ì ‘ê·¼ì´ ë°œìƒí•˜ëŠ” ì‹œì 
   first_article = articles[0]  # ì¸ë±ì‹±í•  ë•Œ
   article_list = list(articles)  # ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜í•  ë•Œ
   for article in articles:  # ë°˜ë³µë¬¸ì„ ì‹¤í–‰í•  ë•Œ
       print(article.title)
   ```

2. ì²´ì´ë‹(Chaining) ê°€ëŠ¥
   ```python
   # ë©”ì„œë“œë¥¼ ê³„ì† ì—°ê²°í•´ì„œ ì‚¬ìš© ê°€ëŠ¥
   Article.objects.filter(title__contains='Django')\
                 .exclude(status='draft')\
                 .order_by('-created_at')
   ```

3. ìºì‹œ ì‚¬ìš©
   ```python
   # í•œ ë²ˆ í‰ê°€ëœ ì¿¼ë¦¬ì…‹ì€ ìºì‹œì— ì €ì¥
   queryset = Article.objects.all()
   print([a.title for a in queryset])  # DB ì¿¼ë¦¬ ì‹¤í–‰
   print([a.title for a in queryset])  # ìºì‹œëœ ê²°ê³¼ ì‚¬ìš©
   ```

```python
# ëŒ“ê¸€ ì‘ì„±ì ì •ë³´ê¹Œì§€ í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸°
articles = Article.objects.prefetch_related(
    Prefetch(
        'comments',
        queryset=Comment.objects.select_related('user')  # ì´ ì¿¼ë¦¬ì…‹ì€ ì‹¤ì œ ë°ì´í„°ê°€ í•„ìš”í•  ë•Œ ì‹¤í–‰ë¨
    )
).all()
```

#### QuerySet vs ì¼ë°˜ Python ë¦¬ìŠ¤íŠ¸
1. QuerySet
   - ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ì´ë‹¤.
   - í•„ìš”í•œ ì‹œì ê¹Œì§€ ì‹¤ì œ DB ì—°ì‚°ì„ ì§€ì—°ì‹œí‚¨ë‹¤.
   - ì²´ì´ë‹ì„ í†µí•œ ì¿¼ë¦¬ ìµœì í™” ê°€ëŠ¥í•˜ë‹¤.

2. ë¦¬ìŠ¤íŠ¸
   - ë©”ëª¨ë¦¬ì— ì´ë¯¸ ë¡œë“œëœ ë°ì´í„°ì´ë‹¤.
   - ì¦‰ì‹œ ëª¨ë“  ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë“œí•œë‹¤.
   - ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™” ë¶ˆê°€ëŠ¥í•˜ë‹¤.

<br>

> ğŸ’¡ **ì„±ëŠ¥ ìµœì í™” TIP**: <br>
> 1. í•­ìƒ í•„ìš”í•œ ë°ì´í„°ë§Œ ê°€ì ¸ì˜¤ê¸° <br>
> 2. QuerySetì€ lazy evaluation í™œìš©í•˜ê¸° <br>
> 3. ì ì ˆí•œ ì¸ë±ìŠ¤ ì‚¬ìš©í•˜ê¸°

<br><br>

---

<br><br>