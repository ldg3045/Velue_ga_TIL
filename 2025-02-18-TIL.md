# GIT TIL 59 - DRFë¡œ íšŒì› ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸°

<br><br>

## ì‹œì‘í•˜ê¸° ì „ì—

Django REST Framework(DRF)ë¡œ íšŒì› ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìŒ íŒ¨í‚¤ì§€ë“¤ì´ í•„ìš”í•˜ë‹¤.

```bash
# DRF ê¸°ë³¸ íŒ¨í‚¤ì§€
pip install djangorestframework

# ì¸ì¦ ê´€ë ¨ íŒ¨í‚¤ì§€
pip install django-rest-auth

# íšŒì›ê°€ì… ì¶”ê°€ ê¸°ëŠ¥ íŒ¨í‚¤ì§€ (ì´ë©”ì¼ ì¸ì¦ ë“±)
pip install django-allauth
```



<br>

## 1. ê¸°ë³¸ ì„¸íŒ…

### settings.py ì„¤ì •
```python
INSTALLED_APPS = [
    ...
    'rest_framework',
    'rest_framework.authtoken',  # í† í° ì¸ì¦
    'dj_rest_auth',  # ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
    'django.contrib.sites',  # ì‚¬ì´íŠ¸ ê´€ë¦¬
    'allauth',  # íšŒì›ê°€ì…
    'allauth.account',  # ê³„ì • ê´€ë¦¬
    'dj_rest_auth.registration',  # íšŒì›ê°€ì… API
]

# ì¸ì¦ í´ë˜ìŠ¤ ì„¤ì •
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.TokenAuthentication',
    ],
}

SITE_ID = 1

# ë¹„ë°€ë²ˆí˜¸ í•´ì‹œí™” ì„¤ì •
PASSWORD_HASHERS = [
    'django.contrib.auth.hashers.PBKDF2PasswordHasher',
    'django.contrib.auth.hashers.PBKDF2SHA1PasswordHasher',
]

# ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•œ ê²½ìš°
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.gmail.com'  # ë©”ì¼ í˜¸ìŠ¤íŠ¸
EMAIL_PORT = 587  # ë©”ì¼ í¬íŠ¸
EMAIL_USE_TLS = True  # TLS ë³´ì•ˆ ì„¤ì •
```

> ğŸ’¡ **ì£¼ì˜**: ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì¤‘ìš” ì •ë³´ ê´€ë¦¬

<br>

## 2. Custom User Model ìƒì„±

### accounts/models.py
```python
from django.contrib.auth.models import AbstractUser
from django.db import models

class User(AbstractUser):
    # blank=True: ì„ íƒì  í•„ë“œ
    # upload_to: ì´ë¯¸ì§€ê°€ ì €ì¥ë  ê²½ë¡œ
    nickname = models.CharField(max_length=50, blank=True)
    profile_image = models.ImageField(upload_to='profile', blank=True)
    
    # í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ì´ì „ ì´ë¯¸ì§€ ì‚­ì œ
    def save(self, *args, **kwargs):
        if self.pk:
            old_user = User.objects.get(pk=self.pk)
            if old_user.profile_image and self.profile_image != old_user.profile_image:
                old_user.profile_image.delete(save=False)
        super().save(*args, **kwargs)
```

### settings.py
```python
# ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ ì„¤ì •
AUTH_USER_MODEL = 'accounts.User'
```

> ğŸ’¡ **ì£¼ì˜**: í”„ë¡œì íŠ¸ ì‹œì‘ ì „ì— ì»¤ìŠ¤í…€ ìœ ì € ëª¨ë¸ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. 
> ì´ë¯¸ migrateë¥¼ í•œ í›„ì—ëŠ” ë³€ê²½ì´ ì–´ë ¤ì›€

<br>

## 3. Serializer êµ¬í˜„

### accounts/serializers.py
```python
from rest_framework import serializers
from django.contrib.auth.password_validation import validate_password
from .models import User

class UserSerializer(serializers.ModelSerializer):
    # write_only: ì‘ë‹µì—ëŠ” í¬í•¨ë˜ì§€ ì•ŠìŒ
    password = serializers.CharField(write_only=True, validators=[validate_password])
    password2 = serializers.CharField(write_only=True)

    class Meta:
        model = User
        fields = ('id', 'username', 'password', 'password2', 'email', 'nickname')
        read_only_fields = ('id',)
    
    # ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ê²€ì¦
    def validate(self, data):
        if data['password'] != data['password2']:
            raise serializers.ValidationError({"password": "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."})
        return data

    # ë¹„ë°€ë²ˆí˜¸ í•´ì‹œí™”í•˜ì—¬ ì €ì¥
    def create(self, validated_data):
        validated_data.pop('password2')
        user = User.objects.create_user(**validated_data)
        return user

class UserDetailSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ('id', 'username', 'email', 'nickname', 'profile_image')
        read_only_fields = ('id', 'username')  # ìˆ˜ì • ë¶ˆê°€ëŠ¥í•œ í•„ë“œ
```

<br>

## 4. View êµ¬í˜„

### accounts/views.py
```python
from rest_framework import generics, permissions, status
from rest_framework.response import Response
from rest_framework.decorators import api_view, permission_classes
from .serializers import UserSerializer, UserDetailSerializer
from .models import User

class SignUpView(generics.CreateAPIView):
    queryset = User.objects.all()
    serializer_class = UserSerializer
    permission_classes = [permissions.AllowAny]  # ëˆ„êµ¬ë‚˜ ì ‘ê·¼ ê°€ëŠ¥, íšŒì›ê°€ì… í˜ì´ì§€ì—ì„œ ì‚¬ìš©

    def post(self, request, *args, **kwargs):
        serializer = self.get_serializer(data=request.data)
        if serializer.is_valid():
            user = serializer.save()
            return Response({
                "message": "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
                "user": UserSerializer(user).data
            }, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST) # ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ 400 ì—ëŸ¬ ë°˜í™˜

class UserDetailView(generics.RetrieveUpdateAPIView):
    serializer_class = UserDetailSerializer
    permission_classes = [permissions.IsAuthenticated]  # ë¡œê·¸ì¸ í•„ìš”, í”„ë¡œí•„ ì¡°íšŒ ë° ìˆ˜ì • í˜ì´ì§€ì—ì„œ ì‚¬ìš©

    def get_object(self):
        return self.request.user

    # í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
    def update(self, request, *args, **kwargs):
        partial = kwargs.pop('partial', False)
        instance = self.get_object()
        serializer = self.get_serializer(instance, data=request.data, partial=partial)
        serializer.is_valid(raise_exception=True)
        self.perform_update(serializer)
        return Response(serializer.data)
```

<br>

## 5. URL ì„¤ì •

### project/urls.py
```python
from django.urls import path, include

urlpatterns = [
    ...
    path('api/auth/', include('dj_rest_auth.urls')),
    path('api/auth/registration/', include('dj_rest_auth.registration.urls')),
    path('api/accounts/', include('accounts.urls')),
]
```

### accounts/urls.py
```python
from django.urls import path
from . import views

urlpatterns = [
    path('signup/', views.SignUpView.as_view()),
    path('profile/', views.UserDetailView.as_view()),
]
```

<br>

## 6. API ì—”ë“œí¬ì¸íŠ¸ ì •ë¦¬

### ê¸°ë³¸ ì¸ì¦ ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸
- POST `/api/auth/login/` : ë¡œê·¸ì¸
- POST `/api/auth/logout/` : ë¡œê·¸ì•„ì›ƒ
- POST `/api/auth/registration/` : íšŒì›ê°€ì…
- GET `/api/auth/user/` : í˜„ì¬ ìœ ì € ì •ë³´
- PUT `/api/auth/user/` : ìœ ì € ì •ë³´ ìˆ˜ì •
- POST `/api/auth/password/change/` : ë¹„ë°€ë²ˆí˜¸ ë³€ê²½

### ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸
- GET `/api/accounts/profile/` : í”„ë¡œí•„ ì¡°íšŒ
- PUT `/api/accounts/profile/` : í”„ë¡œí•„ ìˆ˜ì •

<br>

## 7. í…ŒìŠ¤íŠ¸ ë°©ë²•

### POSTMANì´ë‚˜ DRF ì›¹ ì¸í„°í˜ì´ìŠ¤ë¡œ í…ŒìŠ¤íŠ¸
```bash
# íšŒì›ê°€ì…
POST /api/auth/registration/
{
    "username": "testuser",
    "email": "test@test.com",
    "password1": "complex_password123",
    "password2": "complex_password123"
}

# ë¡œê·¸ì¸
POST /api/auth/login/
{
    "username": "testuser",
    "password": "complex_password123"
}
```


<br><br>

---

<br><br>